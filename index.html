<!DOCTYPE html>
<html lang="en" ng-app="hemnetCommuterApp">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Angular -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.0/angular.min.js"></script>
  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <!-- Leaflet Extra Markers -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-extra-markers@1.2.1/dist/js/leaflet.extra-markers.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-extra-markers@1.2.1/dist/css/leaflet.extra-markers.min.css">
  <!-- Angular Simple Logger -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-simple-logger/0.1.7/angular-simple-logger.min.js"></script>
  <!-- Angular UI for Leaflet -->
  <script src="https://cdn.jsdelivr.net/npm/ui-leaflet@1.0.3/dist/ui-leaflet.min.js"></script>
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <!-- FontAwesome -->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <!-- Chroma-JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js" integrity="sha512-yocoLferfPbcwpCMr8v/B0AB4SWpJlouBwgE0D3ZHaiP1nuu5djZclFEIj9znuqghaZ3tdCMRrreLoM8km+jIQ==" crossorigin="anonymous"></script>

  <!-- Hemnet Commuter -->
  <script src="app.js"></script>
  <link rel="stylesheet" href="styles.css">

  </script>
</head>
<body ng-controller="hemnetCommuterController" style="padding:0;">

<div class="row mr-0 h-100" style="position:relative;">
  <div class="col-md-8 pl-0 h-100 order-2">
      <leaflet bounds="bounds" lf-center="center" event-broadcast="events" markers="markers" layers="layers" style="position: absolute; top: 0; bottom: 0; width: 100%;"></leaflet>
  </div>
  <div class="col-md-4 pr-0 order-1 h-100 overflow-auto">
    <div class="container pt-3">
      <h1 class="h2">
        <img ng-hide="update_results_call_active || commute_map_call_active" src="hemnet.svg" class="float-right" style="width: 40px; margin-top:-5px;">
        <i ng-show="update_results_call_active || commute_map_call_active" class="fa fa-spinner fa-pulse fa-fw float-right text-success"></i>
        Hemnet Commuter
      </h1>
      <p ng-show="update_results_call_active" class="small text-muted">Loading houses..</p>
      <p ng-show="commute_map_call_active" class="small text-muted">Loading commute map..</p>
      <p ng-show="missing_geo.length > 0" class="small text-danger">Missing location for {{missing_geo.length}} houses! Fix on the <a href="update.php">update page</a>.</p>
      <hr>
      <button ng-show="needs_update" ng-click="update_hemnet_results()" ng-class="{'disabled': hemnet_results_updating}" class="btn btn-block btn-warning mb-2">
        <i class="fa fa-refresh mr-2" ng-class="{'fa-spin': hemnet_results_updating}"></i> {{ hemnet_results_update_btn_text }}
      </button>
      <div class="form-row">
        <div class="col-4"><button ng-click="show_filters = !show_filters; show_map_commute_settings = false; show_map_marker_settings = false;" class="btn btn-block btn-secondary"><i class="fa fa-filter mr-2"></i> Filters</button></div>
        <div class="col-4"><button ng-click="show_map_commute_settings = !show_map_commute_settings; show_filters = false; show_map_marker_settings = false;" class="btn btn-block btn-success"><i class="fa fa-bus mr-2"></i> Commute</button></div>
        <div class="col-4"><button ng-click="show_map_marker_settings = !show_map_marker_settings; show_filters = false; show_map_commute_settings = false;" class="btn btn-block btn-info"><i class="fa fa-map-marker mr-2"></i> Map</button></div>
      </div>
      <p class="small text-muted mt-2">
        Showing <span ng-bind="num_results" class="badge badge-secondary"></span> out of <span ng-bind="num_total_results" class="badge badge-secondary"></span> houses.
        &nbsp;
        <a title="Click to toggle update button" href="#" ng-click="needs_update = !needs_update" class="text-muted">Last updated {{ oldest_fetch | date: 'EEE d MMM HH:mm' }}.</a>
      </p>

      <!-- FILTERS -->
      <div ng-show="show_filters" class="pt-3 mt-3 border-top">
        <h4>Filters</h4>
        <h6>Ratings</h6>
        <p>Click to hide houses that are any of the following:</p>
        <table class="table table-sm">
          <tr ng-repeat="(user_id, user_name) in users" ng-class="{'filter-inactive': !filters.hide_ratings[user_id]['yes'] && !filters.hide_ratings[user_id]['maybe'] && !filters.hide_ratings[user_id]['no'] && !filters.hide_ratings[user_id]['not_set'] }">
            <th>{{ user_name }}</th>
            <td class="px-2">
                <input class="form-check-input" type="checkbox" id="rating_yes_{{user_id}}" ng-model="filters.hide_ratings[user_id].yes" ng-change="update_results()">
                <label class="form-check-label" for="rating_yes_{{user_id}}">Yes</label>
            </td>
            <td class="px-2">
                <input class="form-check-input" type="checkbox" id="rating_maybe_{{user_id}}" ng-model="filters.hide_ratings[user_id].maybe" ng-change="update_results()">
                <label class="form-check-label" for="rating_maybe_{{user_id}}">Maybe</label>
            </td>
            <td class="px-2">
                <input class="form-check-input" type="checkbox" id="rating_no_{{user_id}}" ng-model="filters.hide_ratings[user_id].no" ng-change="update_results()">
                <label class="form-check-label" for="rating_no_{{user_id}}">No</label>
            </td>
            <td class="px-2">
                <input class="form-check-input" type="checkbox" id="rating_not_set_{{user_id}}" ng-model="filters.hide_ratings[user_id].not_set" ng-change="update_results()">
                <label class="form-check-label" for="rating_not_set_{{user_id}}">Not set</label>
            </td>
          </tr>
        </table>

        <h6>Commute time thresholds</h6>
        <table class="table table-sm">
          <tr ng-repeat="(commute_id, commute) in commute_locations" ng-class="{'filter-inactive': filters.hide_failed_commutes[commute_id] == '0' }">
            <td class="small">{{ commute.address }}</td>
            <td colspan="2">
              <div class="custom-control custom-switch">
                <input type="checkbox" class="custom-control-input" id="hide_failed_commute_{{commute_id}}" ng-model="filters.hide_failed_commutes[commute_id]" ng-change="update_results()">
                <label class="custom-control-label" for="hide_failed_commute_{{commute_id}}">Hide failing</label>
              </div>
            </td>
          </tr>
        </table>

        <h6>Basic stats</h6>
        <table class="table table-sm">
          <tr ng-class="{'filter-inactive': filters.kommande == 0}">
            <th><label for="filters_kommande">Kommande</label></th>
            <td colspan="2">
              <select id="filters_kommande" ng-model="filters.kommande" ng-change="update_results()" class="custom-select custom-select-sm">
                <option value="0">--</option>
                <option value="1">Show only Kommande</option>
                <option value="-1">Hide Kommande</option>
              </select>
            </td>
          </tr>
          <tr ng-class="{'filter-inactive': filters.bidding == 0}">
            <th><label for="filters_bidding">Bidding</label></th>
            <td colspan="2">
              <select id="filters_bidding" ng-model="filters.bidding" ng-change="update_results()" class="custom-select custom-select-sm">
                <option value="0">--</option>
                <option value="1">Show only Bidding</option>
                <option value="-1">Hide Bidding</option>
              </select>
            </td>
          </tr>
          <tr ng-class="{'filter-inactive': filters.price_min == stats.price[0]}">
            <th><label for="price_min">Min price</label></th>
            <td><input id="price_min" ng-model="filters.price_min" type="range" class="form-control-range" min="{{stats.price[0]}}" max="{{stats.price[1]}}" ng-change="update_results()"></td>
            <td ng-bind="filters.price_min"></td>
          </tr>
          <tr ng-class="{'filter-inactive': filters.price_max == stats.price[1]}">
            <th><label for="price_max">Max price</label></th>
            <td><input id="price_max" ng-model="filters.price_max" type="range" class="form-control-range" min="{{stats.price[0]}}" max="{{stats.price[1]}}" ng-change="update_results()"></td>
            <td ng-bind="filters.price_max"></td>
          </tr>
          <tr ng-class="{'filter-inactive': filters.size_total_min == stats.size_total[0]}">
            <th><label for="size_total_min">Min size <small style="white-space: nowrap;">(Bo + Bi)</small></label></th>
            <td><input id="size_total_min" ng-model="filters.size_total_min" type="range" class="form-control-range" min="{{stats.size_total[0]}}" max="{{stats.size_total[1]}}" ng-change="update_results()"></td>
            <td ng-bind="filters.size_total_min"></td>
          </tr>
          <tr ng-class="{'filter-inactive': filters.size_tomt_min == stats.size_tomt[0]}">
            <th><label for="size_tomt_min">Min tomt</label></th>
            <td><input id="size_tomt_min" ng-model="filters.size_tomt_min" type="range" class="form-control-range" min="{{stats.size_tomt[0]}}" max="{{stats.size_tomt[1]}}" ng-change="update_results()"></td>
            <td ng-bind="filters.size_tomt_min"></td>
          </tr>
        </table>
      </div>

      <!-- COMMUTE SETTINGS -->
      <div ng-show="show_map_commute_settings" class="pt-3 mt-3 border-top">
        <h4>
          Commute settings
          <button ng-click="add_commute_location()" class="btn btn-sm btn-link text-muted" style="font-size: .7rem;">[add place]</button>
        </h4>
        <div class="form-row mb-2" ng-repeat="(commute_id, commute) in commute_locations">
          <div class="col-auto">
            <button ng-click="delete_commute_address(commute_id)" class="btn btn-sm btn-link text-muted border"><i class="fa fa-trash" aria-hidden="true"></i></button>
          </div>
          <div class="col">
            <p ng-bind="commute.address" class="small my-1"></p>
          </div>
          <div class="col-3">
            <input type="time" class="form-control form-control-sm" placeholder="hh:mm" ng-model="commute.max_time" ng-change="update_commute_time(commute_id)" ng-model-options="{updateOn: 'blur'}">
          </div>
        </div>
        <p class="small text-muted my-0">Time is max commute time, hh:mm</p>
      </div>

      <!-- MAP SETTINGS -->
      <div ng-show="show_map_marker_settings" class="pt-3 mt-3 border-top">
        <h4>Map settings</h4>

        <h6 class="mt-4">Map Markers</h6>
        <div class="form-row py-2 small">
          <div class="col-2 my-1">
            <label for="map_settings_marker_colour_icon">Colour + Icon:</label>
          </div>
          <div class="col-10">
            <select id="map_settings_marker_colour_icon" ng-model="map_settings.marker_colour_icon" ng-change="update_marker_col_icon()" class="custom-select custom-select-sm">
              <optgroup ng-repeat="(key,options) in map_setting_selects.marker_colour_icon" label="{{key}}">
                <option ng-repeat="(val, txt) in options" value="{{val}}">{{txt}}</option>
              </optgroup>
            </select>
          </div>
        </div>
        <div class="form-row border-top py-2 small">
          <div class="col-2 my-1">
            <label for="map_settings_marker_colour">Colour:</label>
          </div>
          <div class="col-10">
            <select id="map_settings_marker_colour" ng-model="map_settings.marker_colour" ng-change="update_markers()" class="custom-select custom-select-sm">
              <optgroup ng-repeat="(key,options) in map_setting_selects.marker_colour" label="{{key}}">
                <option ng-repeat="(val, txt) in options" value="{{val}}">{{txt}}</option>
              </optgroup>
            </select>
          </div>
        </div>
        <div class="form-row py-2 border-top small">
          <div class="col-2 my-1">
            <label for="map_settings_marker_icon">Icon:</label>
          </div>
          <div class="col-10">
            <select id="map_settings_marker_icon" ng-model="map_settings.marker_icon" ng-change="update_markers()" class="custom-select custom-select-sm">
              <optgroup ng-repeat="(key,options) in map_setting_selects.marker_icon" label="{{key}}">
                <option ng-repeat="(val, txt) in options" value="{{val}}">{{txt}}</option>
              </optgroup>
            </select>
          </div>
        </div>
      </div>

      <!-- INFO WHEN NO ACTIVE HOUSE -->
      <div ng-show="active_id == false" class="text-muted pt-3 mt-3 border-top">Click a house marker on the map to see more information here.</div>

      <!-- ACTIVE HOUSE DETAILS -->
      <div ng-hide="active_id == false" class="pt-3 mt-3 border-top">
        <h3><a ng-href="{{active_house.url}}" target="_blank"><span ng-bind="active_house.address"></span> <i class="fa fa-external-link" aria-hidden="true"></i></a></h3>
        <h3>
          <span class="badge" ng-class="{'badge-success': active_house.price < 4000000, 'badge-primary': active_house.price > 4000000 && active_house.price < 5700000, 'badge-danger': active_house.price > 5700000}"><span ng-bind="active_house.price / 1000000 | number:3"></span> MKr</span>
          <span class="float-right small mt-2">
            <span ng-show="active_house.upcoming == 1" class="badge badge-success"><i class="fa fa-bolt mr-2" aria-hidden="true"></i>Kommande</span>
            <span ng-show="active_house.ongoing_bidding == 1" class="badge badge-info" style="background-color: #67458c;"><i class="fa fa-gavel mr-2" aria-hidden="true"></i> Budgivning pågår</span>
          </span>
        </h3>
        <img ng-src="{{active_house.image_url}}" class="w-100 my-2">
        <table class="table table-sm small table-hover">
          <tr>
            <th width="50%">Location:</th>
            <td ng-bind="active_house.location_name"></td>
          </tr>
          <tr>
            <th>Days on hemnet:</th>
            <td>
              <span ng-bind="active_house.age"></span>
            </td>
          </tr>
          <tr>
            <th style="white-space: nowrap;">Upcoming visning:</th>
            <td>
              <span ng-bind="active_house.upcoming_open_houses == 1 ? 'Yes' : 'No'"></span>
            </td>
          </tr>
          <tr>
            <th>Size:</th>
            <td>
              <span ng-bind="(active_house.living_area * 1) + (active_house.supplemental_area * 1)"></span> m<sup>2</sup>
              <small>(<span ng-bind="active_house.living_area"></span> Bo <span ng-show="active_house.supplemental_area > 0">+ <span ng-bind="active_house.supplemental_area"></span> Bi</span>)</small>
            </td>
          </tr>
          <tr>
            <th>Tomt:</th>
            <td>
              <span ng-bind="active_house.land_area | number:0"></span> m<sup>2</sup>
            </td>
          </tr>
          <tr>
            <th>Rooms:</th>
            <td><span ng-bind="active_house.rooms"></span></td>
          </tr>
          <tr ng-show="active_house.driftkostnad > 0">
            <th>Driftkostnad:</th>
            <td><span ng-bind="active_house.driftkostnad | number:0"></span> kr/year <small>( <span ng-bind="active_house.driftkostnad / 12 | number:0"></span> kr/month)</small></td>
          </tr>
          <tr>
            <th>Location</th>
            <td>
              <a ng-href="https://www.google.com/maps?q={{active_house.lat}},{{active_house.lng}}" target="_blank" class="badge badge-info">
                <i class="fa fa-map-marker" aria-hidden="true"></i> Google maps &nbsp; <i class="fa fa-external-link" aria-hidden="true"></i>
              </a>
            </td>
          </tr>
          <tr ng-repeat="(commute_id, commute) in commute_locations">
            <th ng-bind="commute.address"></th>
            <td>
              <a ng-href="https://www.google.se/maps/preview?daddr={{active_house.lat}},{{active_house.lng}}&saddr={{commute.lat}},{{commute.lng}}&dirflg=r" target="_blank" ng-class="['badge', {'badge-success': active_house.commute_times[commute_id].pass_threshold, 'badge-danger': !active_house.commute_times[commute_id].pass_threshold}]">
                <span ng-if="active_house.commute_times[commute_id].status == 'OK'">{{active_house.commute_times[commute_id].duration_text}}</span>
                <span ng-if="active_house.commute_times[commute_id].status != 'OK'">{{active_house.commute_times[commute_id].status}}</span>
                &nbsp; <i class="fa fa-external-link" aria-hidden="true"></i>
              </a>
            </td>
          </tr>
          <tr ng-show="active_house.tenure">
            <th>Construction:</th>
            <td><span ng-bind="active_house.construction_year"></span></td>
          </tr>
          <tr ng-show="active_house.tenure">
            <th>Tenure:</th>
            <td><span ng-bind="active_house.tenure"></span></td>
          </tr>
        </table>

        <div class="row my-5 house_ratings">
          <div ng-repeat="(user_id, user_name) in users" class="col-6">
            <h5>{{ user_name }}</h5>
            <div class="btn-group d-flex" role="group">
              <button ng-click="save_rating(user_id, 'yes')" ng-class="{'active': active_house.ratings[user_id] == 'yes'}"  class="btn w-100 btn-outline-success"><i class="fa fa-thumbs-up"></i></button>
              <button ng-click="save_rating(user_id, 'maybe')" ng-class="{'active': active_house.ratings[user_id] == 'maybe'}"  class="btn w-100 btn-outline-info"><i class="fa fa-question"></i></button>
              <button ng-click="save_rating(user_id, 'no')" ng-class="{'active': active_house.ratings[user_id] == 'no'}"  class="btn w-100 btn-outline-danger"><i class="fa fa-thumbs-down"></i></button>
            </div>
            <textarea ng-model="active_house.comments[user_id]" ng-change="save_comment(user_id)" ng-model-options="{ updateOn: 'default blur', debounce: {'default': 500, 'blur': 0} }" class="form-control form-control-sm my-2" placeholder="Comment"></textarea>
          </div>
          <div class="col-12">
            <h6>
              Tags
              <button ng-click="add_tag()" class="btn btn-sm btn-link text-muted" style="font-size: .7rem;">[add tag]</button>
            </h6>
            <button ng-repeat="(tag_id, selected) in active_house.tags" ng-click="save_tag(tag_id)" ng-class="{'active': selected}" class="btn btn-outline-secondary p-1 mr-2 mb-2" style="font-size: .7rem;">{{tags[tag_id]}}</button>
          </div>
        </div>
        <p class="p-3 mb-2 bg-success text-white" style="display:none;" id="saving_ratings_notification">Saving ratings..</p>
      </div>
    </div>
    <footer>
        Hemnet-Commuter was written by <a href="http://phil.ewels.co.uk">Phil Ewels</a>. It is in no way connected with, or endorsed by,
        <a href="https://www.hemnet.se">hemnet.se</a>.<br>
        The code for this website is released with the MIT open-source licence and can be
        viewed on GitHub: <a href="https://github.com/ewels/hemnet-commuter">https://github.com/ewels/hemnet-commuter</a>.
    </footer>
  </div>
</div>

</body>
</html>
